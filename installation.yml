---
- name: Update local cache
  include: configuration/update_cache.yml
  tags:
  - cache

- name: Setup OS
  include: configuration/opdk-setup-os.yml
  vars:
    hosts: 'planet'
  tags:
  - os
  - os-pre-req

- name: Update user with root privilege
  include: configuration/update-user.yml
  vars:
    hosts: 'planet'
    user: 'root'
  tags:
  - root-user
  - os-pre-req

- name: Setup Edge pre-requisites
  include: components/opdk-pre-requisites.yml
  vars:
    hosts: 'planet'
    jdk_version: '1.8'
    opdk_ldap_type: '2'
  tags:
  - apigee-pre-req

- name: Setup Cassandra & Zookeeper in DC-2
  include: components/opdk-install-component.yml
  vars:
    hosts: 'dc-2-ds'
    component_profile: 'ds'
    jdk_version: '1.8'
    opdk_ldap_type: '2'
  tags:
  - dc-2-ds
  - ds

- name: Refresh Cassandra & Zookeeper in DC-1 with DC-2 setup
  include: components/opdk-install-component.yml
  vars:
    hosts: 'dc-1-ds'
    component_profile: 'ds'
    jdk_version: '1.8'
    opdk_ldap_type: '2'
  tags:
  - dc-1-ds
  - ds

- name: Update Cassandra client on DC-1
  include: components/opdk-cassandra-client-update.yml
  vars:
     hosts: 'dc-1-ms'
     jdk_version: '1.8'
  tags:
  - dc-1-ms
  - ms

- name: Refresh Management Server on DC-1
  include: components/opdk-install-component.yml
  vars:
    hosts: 'dc-1-ms'
    component_profile: 'ms'
    jdk_version: '1.8'
    opdk_ldap_type: '2'
  tags:
  - dc-1-ms
  - ms

- name: Rebuild Cassandra on DC-2
  include: components/opdk-cassandra-rebuild.yml
  vars:
    hosts: 'dc-2-ds'
    jdk_version: '1.8'
  tags:
  - dc-2-ms
  - ms

- name: Setup Management Server on DC-2
  include: components/opdk-install-component.yml
  vars:
    hosts: 'dc-2-ms'
    component_profile: 'ms'
    jdk_version: '1.8'
    opdk_ldap_type: '2'
  tags:
  - dc-2-ms
  - ms

- name: Setup RMP on DC-2
  include: components/opdk-install-component.yml
  vars:
    hosts: 'dc-2-rmp'
    component_profile: 'rmp'
    jdk_version: '1.8'
  tags:
  - dc-2-rmp
  - rmp

- name: Unset reachable flag for RMP on DC-1
  include: configuration/opdk-set-reachable.yml
  vars:
    hosts: 'dc-1-rmp'
    reachability: 'false'
  tags:
  - dc-1-rmp
  - rmp

- name: Refresh the RMP setup on DC-1
  include: components/opdk-install-component.yml
  vars:
    hosts: 'dc-1-rmp'
    component_profile: 'rmp'
    jdk_version: '1.8'
  tags:
  - dc-1-rmp
  - rmp

- name: Set reachable flag for RMP on DC-1
  include: configuration/opdk-set-reachable.yml
  vars:
    hosts: 'dc-1-rmp'
    reachability: 'true'
  tags:
  - dc-1-rmp
  - rmp

- name: Setup Qpid on DC-2
  include: components/opdk-install-component.yml
  vars:
    hosts: 'dc-2-qpid'
    component_profile: 'qs'
    jdk_version: '1.8'
  tags:
  - dc-2-qpid
  - qpid

- name: Register Qpid on DC-2
  include: components/opdk-setup-qpid-add.yml
  vars:
    hosts: 'dc-2-qpid'
  tags:
  - dc-2-qpid-registration
  - qpid

- name: Setup Postgres Master on DC-2
  include: components/opdk-setup-postgres-common.yml
  vars:
    hosts: 'dc-2-pgmaster'
    pg_component: 'master'
    jdk_version: '1.8'
  tags:
  - dc-2-pgmaster
  - pgmaster
  - pg

- name: Setup Postgres Standby on DC-2
  include: components/opdk-setup-postgres-common.yml
  vars:
    hosts: 'dc-2-pgstandby'
    pg_component: 'standby'
    jdk_version: '1.8'
  tags:
  - dc-2-pgstandby
  - pg
  - pgstandby

- name: Register analytics cluster on DC-2
  include: components/opdk-setup-postgresql-add.yml
  vars:
    hosts: 'dc-2-pgmaster'
    pgmaster_group_name: 'dc-2-pgmaster'
    pgstandby_group_name: 'dc-2-pgstandby'
  tags:
  - dc-2-pg-registration
  - pg
  - pg-add

- name: Setup org on DC-2
  include: configuration/opdk-setup-org.yml
  vars:
    hosts: 'dc-2-ms'
  tags:
  - org

- name: Validate RMP proxy functionality on DC-2
  include: validations/opdk-setup-validate.yml
  vars:
    hosts: 'dc-2-rmp'
  tags:
  - validation

- name: Validate internal port connectivity
  include: validations/opdk-internal-port-connectivity-validator.yml
  tags:
  - port-validator

- name: Report status for all nodes
  include: validations/opdk-setup-status.yml
  vars:
    hosts: 'planet'
  tags:
  - status

- name: Download logs and configs from DC-1-DS
  include: validations/opdk-setup-log-files.yml
  vars:
    hosts: dc-1-ds
  tags:
  - logs
  - dc-1

- name: Download logs and configs from DC-2-DS
  include: validations/opdk-setup-log-files.yml
  vars:
    hosts: dc-2-ds
  tags:
  - logs
  - dc-2

- name: Download logs and configs from DC-1-MS
  include: validations/opdk-setup-log-files.yml
  vars:
    hosts: dc-1-ms
  tags:
  - logs
  - dc-1

- name: Download logs and configs from DC-2-MS
  include: validations/opdk-setup-log-files.yml
  vars:
    hosts: dc-2-ms
  tags:
  - logs
  - dc-2

- name: Download logs and configs from DC-1-RMP
  include: validations/opdk-setup-log-files.yml
  vars:
    hosts: dc-1-rmp
  tags:
  - logs
  - dc-1

- name: Download logs and configs from DC-2-RMP
  include: validations/opdk-setup-log-files.yml
  vars:
    hosts: dc-2-rmp
  tags:
  - logs
  - dc-2

- name: Download logs and configs from DC-1-QPID
  include: validations/opdk-setup-log-files.yml
  vars:
    hosts: dc-1-qpid
  tags:
  - logs
  - dc-1

- name: Download logs and configs from DC-2-QPID
  include: validations/opdk-setup-log-files.yml
  vars:
    hosts: dc-2-qpid
  tags:
  - logs
  - dc-2

- name: Download logs and configs from DC-1-PGMASTER
  include: validations/opdk-setup-log-files.yml
  vars:
    hosts: dc-1-pgmaster
  tags:
  - logs
  - dc-1

- name: Download logs and configs from DC-2-PGMASTER
  include: validations/opdk-setup-log-files.yml
  vars:
    hosts: dc-2-pgmaster
  tags:
  - logs
  - dc-2

- name: Download logs and configs from DC-1-PGSTANDBY
  include: validations/opdk-setup-log-files.yml
  vars:
    hosts: dc-1-pgstandby
  tags:
  - logs
  - dc-1

- name: Download logs and configs from DC-2-PGSTANDBY
  include: validations/opdk-setup-log-files.yml
  vars:
    hosts: dc-2-pgstandby
  tags:
  - logs
  - dc-2


